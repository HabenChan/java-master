<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>文件上传测试</title>
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.js"></script>
    <script src="http://cdn.staticfile.org/webuploader/0.1.5/webuploader.js"></script>
</head>
<body>
<div>
    <div>
        <form accept-charset="UTF-8"
              action="/upload/uploadFile"
              method="post"
              enctype="multipart/form-data">
            <label for="normal">一般文件上传</label>
            <input id="normal" type="file">
            <input type="submit" value="提交">
        </form>
    </div>
    <br/>
    <br/>
    <br/>
    <div>
        <label for="big">大文件上传断点续传</label>
        <input id="big" type="file" onchange="uploadBigFile(event)">
        <div>
            <span>进度:</span>
            <span id="progress"></span>
        </div>
    </div>
</div>
<script>
    function uploadBigFile(event) {
        let fileUploader = new FileUploader(5 * 1024 * 1024,
            percent => {
                document.getElementById("progress").innerHTML = percent + "%";
            }
        );
        let selectedFiles = event.target.files;
        fileUploader.startUpload(selectedFiles);
    }

    class FileUploader {
        /**
         * @param chunkSize 分片大小
         * @param progress 发送过程回调函数
         */
        constructor(chunkSize, progress) {
            this.chunkSize = chunkSize;
            this.progress = progress;
            this.fileObject = {};
            this.wulObj = {};
            this._initGlobalWebUploader();
            this.webUploader = this._newWebUploader();
        }

        startUpload(files) {
            this.webUploader.addFiles(files);
        }

        _initGlobalWebUploader() {
            WebUploader.Uploader.register(
                {
                    "before-send-file": "beforeSendFile",
                    "before-send": "beforeSend",
                    "after-send-file": "afterSendFile"
                },
                {
                    beforeSendFile: file => {
                        console.log("beforeSendFile:", file);
                        let deferred = WebUploader.Deferred();
                        // 计算文件MD5
                        this.webUploader
                            .md5File(file)
                            .then(fileMd5 => {
                                    console.log("检查文件中...");
                                    this.wulObj[file.id] = {};
                                    this.wulObj[file.id].fileMd5 = fileMd5;
                                    this.wulObj[file.id].fileSize = file.size;
                                    this.wulObj[file.id].chunkSize = this.chunkSize;
                                    this.wulObj[file.id].fileName = file.name;
                                    let reqJsonObj = Object.assign({}, this.wulObj[file.id]);
                                    $.ajax({
                                        type: "POST",
                                        url: "http://localhost:8896/upload/checkBigFile",
                                        data: reqJsonObj,
                                        dataType: "json",
                                        success: resJsonObj => {
                                            if (resJsonObj.code === 0) {
                                                console.log("文件检查完成,状态:已完成上传,url:", resJsonObj.data);
                                                this.fileObject[file.id].url = resJsonObj.data;
                                                deferred.reject();
                                            } else {
                                                console.log("文件检查完成,状态:缺失分片", resJsonObj.data);
                                                this.fileObject[file.id].missingChunks = resJsonObj.data;
                                                deferred.resolve();
                                            }
                                        },
                                        error: e => {
                                            console.error("上传失败,请联系管理员", e);
                                            deferred.reject();
                                        },
                                    });
                                    return deferred.promise();
                                }
                            );
                        return deferred.promise();
                    },
                    beforeSend: block => {
                        console.log("beforeSend:", block);
                        let deferred = WebUploader.Deferred();
                        if (this.fileObject[block.file.id].missingChunks.indexOf(block.chunk) === -1) {
                            return deferred.reject();
                        }
                        this.webUploader
                            .md5File(block.blob)
                            .then(chunkMd5 => {
                                    this.wulObj[block.file.id][block.chunk] = {};
                                    this.wulObj[block.file.id][block.chunk].formData = {
                                        chunk: block.chunk,
                                        fileMd5: this.wulObj[block.file.id].fileMd5,
                                        chunkMd5: chunkMd5,
                                    };
                                    deferred.resolve();
                                }
                            );
                        return deferred.promise();
                    },
                    afterSendFile: file => {
                        console.log("afterSendFile:", file, "所有分片上传完成,通知服务器合并文件分片...");
                        $.ajax({
                            type: "POST",
                            url: "http://localhost:8896/upload/mergeBigFile",
                            data: {
                                fileMd5: this.wulObj[file.id].fileMd5,
                                fileName: file.name,
                                chunkSize: this.chunkSize,
                                size: this.wulObj[file.id].fileSize,
                            },
                            success: resJsonObj => {
                                if (resJsonObj.code === 0) {
                                    console.log("服务器合并文件分片完成");
                                    if (this.fileObject[file.id]) {
                                        this.fileObject[file.id].status = "success";
                                        this.fileObject[file.id].percentage = 100;
                                        this.fileObject[file.id].url = resJsonObj.url;
                                    }
                                } else {
                                    console.log("文件分片合并失败:" + resJsonObj);
                                    if (this.fileObject[file.id]) {
                                        this.fileObject[file.id].status = "exception";
                                    }
                                }
                                this.wulObj[file.id] = {};
                            }
                        });
                    }
                }
            );
        }

        _newWebUploader() {
            let webUploader = WebUploader.create({
                // 文件上传路径
                server: "http://localhost:8896/upload/uploadBigFile",
                // 自动上传
                auto: true,
                // 禁止浏览器打开文件
                disableGlobalDnd: true,
                // 分片上传
                chunked: true,
                // 分片大小
                chunkSize: this.chunkSize,
                // 分片上传失败重试次数
                chunkRetry: 1,
                // 图片不做压缩
                compress: false,
                // 提前准备好下一个文件
                prepareNextFile: true,
                // 限制单个文件大小
                fileSingleSizeLimit: 200 * 1024 * 1024,
                fileNumLimit: 5,
                //线程数
                threads: 5,
                // 限制格式
                accept: {
                    title: 'file',
                    extensions: '*',
                    mimeTypes: '*/*'
                }
            });
            webUploader.on(
                "fileQueued",
                file => {
                    console.log("fileQueued:", file);
                    this.fileObject[file.id] = {};
                    this.fileObject[file.id].name = file.name;
                    this.fileObject[file.id].status = "ready";
                    this.fileObject[file.id].blobUrl = URL.createObjectURL(file.source.source);
                }
            );
            webUploader.on(
                "uploadBeforeSend",
                (block, headers) => {
                    console.log("uploadBeforeSend:", block, headers);
                    Object.assign(headers, this.wulObj[block.file.id][block.chunk].formData);
                }
            );
            webUploader.on(
                "uploadProgress",
                (file, percentage) => {
                    console.log("uploadProgress:", file, percentage);
                    this.fileObject[file.id].showPercentage = true;
                    this.fileObject[file.id].percentage = Math.ceil(percentage * 100);
                    this.fileObject[file.id].status = "uploading";
                    this.progress(this.fileObject[file.id].percentage);
                }
            );
            webUploader.on(
                "uploadComplete",
                file => {
                    console.log("uploadComplete:", file);
                    this.fileObject[file.id].showPercentage = false;
                    this.fileObject[file.id].status = "complete";
                }
            );
            webUploader.on(
                "error",
                type => {
                    console.error("error:", type);
                }
            );
            return webUploader;
        }
    }
</script>
</body>
</html>
